@page "/"

@using BitcoinPriceForecasting.ViewModels
@using Common
@using Common.Entities
@using System.Globalization
@using Microsoft.Extensions.ML
@using Microsoft.ML
@using Microsoft.ML.Transforms.TimeSeries

@inject CryptoDataStore CryptoDataStore
@inject PredictionEnginePool<HistoricalDataRecord, HictoricalDataPredictionResult> PredictionEnginePool

<PageTitle>Bitcoin Info</PageTitle>

<h1>Інформація про біткоїн</h1>

@if (_coinData == null)
{
    <p>Немає інформації</p>
}
else
{
    <div class="custom-container">
        <h2>Опис:</h2>
        <p>
            <img src="@_coinData.Image.Large" alt="Cryptocurrency" class="logo" />
            @_coinData.Description.English
        </p>
        
        <p class="text">
            
        </p>
    </div>
    <div class="custom-container">
        <h2>Основна інформація:</h2>
        <ol class="rectangle-list">
            <li><a href="">Дата створення: @_coinData.GenesisDate</a></li>
            <li><a href="">Найвища ціна за увеь час: @_coinData.MarketData.AthPrice["usd"] доларів</a></li>
            <li><a href="">Поточна ціна: @_coinData.MarketData.CurrentPrice["usd"] доларів</a></li>
            <li><a href="">Найвища ціна за 24 години: @_coinData.MarketData.High24h["usd"] доларів</a></li>
            <li><a href="">Найнища ціна за 24 години: @_coinData.MarketData.Low24h["usd"] доларів </a></li>
            <li><a href="">Зміна ціни за 24 години: @_coinData.MarketData.PriceChange24h доларів</a></li>
            <li><a href="">Зміна ціни у відсотках за 24 години: @_coinData.MarketData.PriceChangePercentage24h %</a></li>
            <li><a href="">Зміна ціни у відсотках за 7 днів: @_coinData.MarketData.PriceChangePercentage7d %</a></li>
            <li><a href="">Зміна ціни у відсотках за 30 днів:@_coinData.MarketData.PriceChangePercentage30d %</a></li>
            <li><a href="">Зміна ціни у відсотках за 60 днів:@_coinData.MarketData.PriceChangePercentage60d %</a></li>
            <li><a href="">Зміна ціни у відсотках за 20 днів:@_coinData.MarketData.PriceChangePercentage200d %</a></li>
        </ol>
    </div>

    <div class="custom-container">
        <h2>Технічна інформація:</h2>
        <ol class="rectangle-list">
            <li><a href="@_coinData.Links.Whitepaper">Білий лист: @_coinData.Links.Whitepaper</a></li>
            <li><a href="#">Алгоритм хешування: @_coinData.HashingAlgorithm</a></li>
        </ol>
        <ol class="rectangle-list">
                GitHub репозиторії:
                    @if (_coinData.Links.Repositories.GitHub != null && _coinData.Links.Repositories.GitHub.Any())
                    {
                        foreach (var repo in _coinData.Links.Repositories.GitHub)
                        {
                            <li><a href="@repo" target="_blank">@repo</a></li>
                        }
                    }
                    else
                    {
                        <li><a href="#">Відсутні репозиторії</a></li>
                    }
        </ol>
        <ol class="rectangle-list">
                Bitbucket репозиторії:
                    @if (_coinData.Links.Repositories.Bitbucket != null && _coinData.Links.Repositories.Bitbucket.Any())
                    {
                        foreach (var repo in _coinData.Links.Repositories.Bitbucket)
                        {
                            <li><a href="@repo" target="_blank">@repo</a></li>
                        }
                    }
                    else
                    {
                        <li><a href="#">Відсутні репозиторії</a></li>
                    }
        </ol>
    </div>
    

    <RadzenStack class="rz-p-0 rz-p-md-6 rz-p-lg-12" Gap="4rem">
        <RadzenCard Variant="Variant.Outlined">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenCheckBox @bind-Value="@_showDataLabels" Name="dataLabels"></RadzenCheckBox>
                    <RadzenLabel Text="Show Data Labels" Component="dataLabels" />
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>

        <RadzenChart class="mt-0">
            <h3>Ціна біткоїна за місяць</h3>
            <RadzenChartTooltipOptions/>
            <RadzenLineSeries Smooth="true" Data="@_monthlyBitcoinPrices" CategoryProperty="Date" LineType="LineType.Solid" ValueProperty="Price">
                <RadzenMarkers Visible="true" MarkerType="MarkerType.Circle" Size="5" />
                <RadzenSeriesDataLabels Visible="@_showDataLabels" />
            </RadzenLineSeries>
            <RadzenCategoryAxis Padding="20" LabelAutoRotation="-90"/>
            <RadzenValueAxis Formatter="@FormatAsUSD">
                <RadzenGridLines Visible="true" />
                <RadzenAxisTitle Text="Prices" />
            </RadzenValueAxis>
        </RadzenChart>

        <RadzenChart>
            <h3>Середня ціна за останні 10 місяців</h3>
            <RadzenChartTooltipOptions />
            <RadzenLineSeries Smooth="true" Data="@_lastTenMonthAvarageBitcoinPrices" CategoryProperty="Date" LineType="LineType.Solid" ValueProperty="Price">
                <RadzenMarkers Visible="true" MarkerType="MarkerType.Circle" Size="5" />
                <RadzenSeriesDataLabels Visible="@_showDataLabels" />
            </RadzenLineSeries>
            <RadzenCategoryAxis Padding="20" LabelAutoRotation="-90" />
            <RadzenValueAxis Formatter="@FormatAsUSD">
                <RadzenGridLines Visible="true" />
                <RadzenAxisTitle Text="Prices" />
            </RadzenValueAxis>
        </RadzenChart>

        <RadzenChart>
            <h3>Максимальна ціна за останні 10 місяців</h3>
            <RadzenChartTooltipOptions />
            <RadzenLineSeries Smooth="true" Data="@_lastTenMonthMaxBitcoinPrices" CategoryProperty="Date" LineType="LineType.Solid" ValueProperty="Price">
                <RadzenMarkers Visible="true" MarkerType="MarkerType.Circle" Size="5" />
                <RadzenSeriesDataLabels Visible="@_showDataLabels" />
            </RadzenLineSeries>
            <RadzenCategoryAxis Padding="20" LabelAutoRotation="-90" />
            <RadzenValueAxis Formatter="@FormatAsUSD">
                <RadzenGridLines Visible="true" />
                <RadzenAxisTitle Text="Prices" />
            </RadzenValueAxis>
        </RadzenChart>

        <RadzenChart>
            <h3>Прогнозована ціна біткоїна</h3>
            <RadzenChartTooltipOptions />
            <RadzenLineSeries Smooth="true" Data="@_predictedMonthlyBitcoinPrices" CategoryProperty="Date" LineType="LineType.Solid" ValueProperty="Price">
                <RadzenMarkers Visible="true" MarkerType="MarkerType.Circle" Size="5" />
                <RadzenSeriesDataLabels Visible="@_showDataLabels" />
            </RadzenLineSeries>
            <RadzenCategoryAxis Padding="20" LabelAutoRotation="-90" />
            <RadzenValueAxis Formatter="@FormatAsUSD">
                <RadzenGridLines Visible="true" />
                <RadzenAxisTitle Text="Prices" />
            </RadzenValueAxis>
        </RadzenChart>
    </RadzenStack>
}

@code{
    private const string BitcoinId = "bitcoin";

    private CoinData? _coinData;
    private CoinHistoricalData? _coinHistoricalData;
    private BitcoinPriceDataViewModel[] _monthlyBitcoinPrices;
    private BitcoinPriceDataViewModel[] _predictedMonthlyBitcoinPrices;
    private BitcoinPriceDataViewModel[] _lastTenMonthAvarageBitcoinPrices;
    private BitcoinPriceDataViewModel[] _lastTenMonthMaxBitcoinPrices;
    private bool _showDataLabels = false;

    protected override async Task OnInitializedAsync()
    {
        await CryptoDataStore.InitializeAsync();

        _coinData = CryptoDataStore.CoinData;
        _coinHistoricalData = CryptoDataStore.CoinHistoricalData;

        var bitcoinhistoricalData = _coinHistoricalData.Prices
            .Select(x => new BitcoinPriceDataViewModel
            {
                Date = UnixTimeStampToDateOnly(Convert.ToDouble(x[0])).ToString("yyyy-MM-dd"),
                Price = Convert.ToDouble(x[1])
            })
            .ToArray();

        _lastTenMonthAvarageBitcoinPrices = bitcoinhistoricalData
            .GroupBy(data => DateTime.Parse(data.Date).ToString("yyyy-MM"))
            .Take(10)
            .Select(group => new BitcoinPriceDataViewModel
            {
                Date = group.Key,
                Price = group.Average(x => x.Price) 
            })
            .ToArray();

        _lastTenMonthMaxBitcoinPrices = bitcoinhistoricalData
            .GroupBy(data => DateTime.Parse(data.Date).ToString("yyyy-MM"))
            .Take(10)
            .Select(group => new BitcoinPriceDataViewModel
                {
                    Date = group.Key,
                    Price = group.Max(x => x.Price)
                })
            .ToArray();

        _monthlyBitcoinPrices = bitcoinhistoricalData
           .Where(data => DateTime.Parse(data.Date) > DateTime.Now.AddMonths(-1))
           .ToArray();

        _predictedMonthlyBitcoinPrices = new BitcoinPriceDataViewModel[_monthlyBitcoinPrices.Length];
        var _engine = PredictionEnginePool.GetPredictionEngine("FastForest");

        for (int i = 0; i < _monthlyBitcoinPrices.Length; i++)
        {
            HistoricalDataRecord dataRecord = new()
                {
                    Date = new DateTimeOffset(DateTime.Parse(_monthlyBitcoinPrices[i].Date)).ToUnixTimeSeconds(),
                    MarketCap = GetAverageMarketCapLastMonth(),
                    TotalVolume = GetAverageTotalVolumeLastMonth(),
                };
            HictoricalDataPredictionResult v = _engine.Predict(dataRecord);
            _predictedMonthlyBitcoinPrices[i] = new BitcoinPriceDataViewModel
                {
                    Date = _monthlyBitcoinPrices[i].Date,
                    Price = v.PredictedValue,
                };
        }
    }

    private string FormatAsUSD(object value)
    {
        return ((double)value).ToString("C0", CultureInfo.CreateSpecificCulture("en-US"));
    }


    public DateTime UnixTimeStampToDateOnly(double unixTimeStamp)
    {   
        unixTimeStamp /= 1000;
        DateTime dateTime = new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc);
        dateTime = dateTime.AddSeconds(unixTimeStamp).ToLocalTime();
        return dateTime;        
    }

    public long DateTimeToUnixTimestamp(DateTime dateTime)
    {
        return new DateTimeOffset(dateTime).ToUnixTimeSeconds();
    }

    public float GetAverageMarketCapLastMonth()
    {
        var thirtyDaysAgo = DateTimeOffset.UtcNow.AddDays(-30).ToUnixTimeMilliseconds();

        var averageMarketCap = _coinHistoricalData.MarketCaps
            .Where(mc => mc[0] >= thirtyDaysAgo) 
            .Select(mc => mc[1])               
            .DefaultIfEmpty()                  
            .Average();                        

        return averageMarketCap;
    }

    public float GetAverageTotalVolumeLastMonth()
    {
        var thirtyDaysAgo = DateTimeOffset.UtcNow.AddDays(-30).ToUnixTimeMilliseconds();

        var averageMarketCap = _coinHistoricalData.MarketCaps
            .Where(mc => mc[0] >= thirtyDaysAgo)
            .Select(mc => mc[1])
            .DefaultIfEmpty()
            .Average();

        return averageMarketCap;
    }
}