@page "/"

@using BitcoinPriceForecasting.ViewModels
@using Common
@using Common.Entities
@using System.Globalization
@using Microsoft.Extensions.ML
@using Microsoft.ML
@using Microsoft.ML.Transforms.TimeSeries

@inject CryptoDataFetcher Datafatcher
@* @inject PredictionEnginePool<HistoricalDataRecord, HictoricalDataSsaPredictionResult> PredictionEnginePool *@

<PageTitle>Bitcoin Info</PageTitle>

<h1>Інформація про біткоїн</h1>

@if (_coinData == null)
{
    <p>Немає інформації</p>
}
else
{
    <p>
        Опис: @_coinData.Description.English<br>
        <img src="@_coinData.Image.Large" alt="Cryptocurrency" style="max-width: 300px; height: auto;" />
        <br>
        Дата створення: @_coinData.GenesisDate<br>
        Найвища ціна за увеь час: @_coinData.MarketData.AthPrice["usd"] доларів<br>
        Поточна ціна: @_coinData.MarketData.CurrentPrice["usd"] доларів<br>
        Найвища ціна за 24 годині: @_coinData.MarketData.High24h["usd"] доларів<br>
        Найнища ціна за 24 годині: @_coinData.MarketData.Low24h["usd"] доларів<br>
        Price change 24 hours: @_coinData.MarketData.PriceChange24h доларів<br>
        Зміна ціни у відсотках за 24 години: @_coinData.MarketData.PriceChangePercentage24h %<br>
        Зміна ціни у відсотках за 7 днів: @_coinData.MarketData.PriceChangePercentage7d %<br>
        Зміна ціни у відсотках за 30 днів: @_coinData.MarketData.PriceChangePercentage30d %<br>
        Зміна ціни у відсотках за 60 днів: @_coinData.MarketData.PriceChangePercentage60d %<br>
        Зміна ціни у відсотках за  200 днів: @_coinData.MarketData.PriceChangePercentage200d %<br>
        <br>
        Білий лист:  @_coinData.Links.Whitepaper<br>
        Алгоритм хешування: @_coinData.HashingAlgorithm<br>
        GitHub репозиторії:<br>
        @foreach (var repo in _coinData.Links.Repositories.GitHub)
        {
            <p>@repo</p>
            <br>
        }

        Bitbucket  репозиторії:<br>
        @foreach (var repo in _coinData.Links.Repositories.Bitbucket)
        {
            <p>@repo </p>
            <br>
        }
    </p>

    <RadzenStack class="rz-p-0 rz-p-md-6 rz-p-lg-12" Gap="4rem">
        <RadzenCard Variant="Variant.Outlined">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenCheckBox @bind-Value="@_showDataLabels" Name="dataLabels"></RadzenCheckBox>
                    <RadzenLabel Text="Show Data Labels" Component="dataLabels" />
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>

        <RadzenChart class="mt-0">
            <h3>Ціна біткоїна за місяць</h3>
            <RadzenChartTooltipOptions/>
            <RadzenLineSeries Smooth="true" Data="@_monthlyBitcoinPrices" CategoryProperty="Date" LineType="LineType.Solid" ValueProperty="Price">
                <RadzenMarkers Visible="true" MarkerType="MarkerType.Circle" Size="5" />
                <RadzenSeriesDataLabels Visible="@_showDataLabels" />
            </RadzenLineSeries>
            <RadzenCategoryAxis Padding="20" LabelAutoRotation="-90"/>
            <RadzenValueAxis Formatter="@FormatAsUSD">
                <RadzenGridLines Visible="true" />
                <RadzenAxisTitle Text="Prices" />
            </RadzenValueAxis>
        </RadzenChart>

        <RadzenChart>
            <h3>Середня ціна за останні 10 місяців</h3>
            <RadzenChartTooltipOptions />
            <RadzenLineSeries Smooth="true" Data="@_lastTenMonthAvarageBitcoinPrices" CategoryProperty="Date" LineType="LineType.Solid" ValueProperty="Price">
                <RadzenMarkers Visible="true" MarkerType="MarkerType.Circle" Size="5" />
                <RadzenSeriesDataLabels Visible="@_showDataLabels" />
            </RadzenLineSeries>
            <RadzenCategoryAxis Padding="20" LabelAutoRotation="-90" />
            <RadzenValueAxis Formatter="@FormatAsUSD">
                <RadzenGridLines Visible="true" />
                <RadzenAxisTitle Text="Prices" />
            </RadzenValueAxis>
        </RadzenChart>

        <RadzenChart>
            <h3>Максимальна ціна за останні 10 місяців</h3>
            <RadzenChartTooltipOptions />
            <RadzenLineSeries Smooth="true" Data="@_lastTenMonthMaxBitcoinPrices" CategoryProperty="Date" LineType="LineType.Solid" ValueProperty="Price">
                <RadzenMarkers Visible="true" MarkerType="MarkerType.Circle" Size="5" />
                <RadzenSeriesDataLabels Visible="@_showDataLabels" />
            </RadzenLineSeries>
            <RadzenCategoryAxis Padding="20" LabelAutoRotation="-90" />
            <RadzenValueAxis Formatter="@FormatAsUSD">
                <RadzenGridLines Visible="true" />
                <RadzenAxisTitle Text="Prices" />
            </RadzenValueAxis>
        </RadzenChart>

        <RadzenChart>
            <h3>Прогнозована ціна біткоїна</h3>
            <RadzenChartTooltipOptions />
            <RadzenLineSeries Smooth="true" Data="@_predictedMonthlyBitcoinPrices" CategoryProperty="Date" LineType="LineType.Solid" ValueProperty="Price">
                <RadzenMarkers Visible="true" MarkerType="MarkerType.Circle" Size="5" />
                <RadzenSeriesDataLabels Visible="@_showDataLabels" />
            </RadzenLineSeries>
            <RadzenCategoryAxis Padding="20" LabelAutoRotation="-90" />
            <RadzenValueAxis Formatter="@FormatAsUSD">
                <RadzenGridLines Visible="true" />
                <RadzenAxisTitle Text="Prices" />
            </RadzenValueAxis>
        </RadzenChart>
    </RadzenStack>
}

@code{
    private const string BitcoinId = "bitcoin";

    private CoinData? _coinData;
    private CoinHistoricalData? _coinHistoricalData;
    private BitcoinPriceDataViewModel[] _monthlyBitcoinPrices;
    private BitcoinPriceDataViewModel[] _predictedMonthlyBitcoinPrices;
    private BitcoinPriceDataViewModel[] _lastTenMonthAvarageBitcoinPrices;
    private BitcoinPriceDataViewModel[] _lastTenMonthMaxBitcoinPrices;
    private bool _showDataLabels = false;

    protected override async Task OnInitializedAsync()
    {
        _coinData = await Datafatcher.GetData(BitcoinId);
        _coinHistoricalData = await Datafatcher.GetHistoricalData(BitcoinId);

        var bitcoinhistoricalData = _coinHistoricalData.Prices
            .Select(x => new BitcoinPriceDataViewModel
            {
                Date = UnixTimeStampToDateOnly(Convert.ToDouble(x[0])).ToString("yyyy-MM-dd"),
                Price = Convert.ToDouble(x[1])
            })
            .ToArray();

        _lastTenMonthAvarageBitcoinPrices = bitcoinhistoricalData
            .GroupBy(data => DateTime.Parse(data.Date).ToString("yyyy-MM"))
            .Take(10)
            .Select(group => new BitcoinPriceDataViewModel
            {
                Date = group.Key,
                Price = group.Average(x => x.Price) 
            })
            .ToArray();

        _lastTenMonthMaxBitcoinPrices = bitcoinhistoricalData
            .GroupBy(data => DateTime.Parse(data.Date).ToString("yyyy-MM"))
            .Take(10)
            .Select(group => new BitcoinPriceDataViewModel
                {
                    Date = group.Key,
                    Price = group.Max(x => x.Price)
                })
            .ToArray();

        _monthlyBitcoinPrices = bitcoinhistoricalData
           .Where(data => DateTime.Parse(data.Date) > DateTime.Now.AddMonths(-1))
           .ToArray();

        _predictedMonthlyBitcoinPrices = new BitcoinPriceDataViewModel[_monthlyBitcoinPrices.Length];
        //var _engine = PredictionEnginePool.GetPredictionEngine("TrainedModel");

        // for (int i = 0; i < _monthlyBitcoinPrices.Length; i++)
        // {
        //     HistoricalDataRecord dataRecord = new()
        //         {
        //             Date = new DateTimeOffset(DateTime.Parse(_monthlyBitcoinPrices[i].Date)).ToUnixTimeSeconds(),
        //             MarketCap = GetAverageMarketCapLastMonth(),
        //             TotalVolume = GetAverageTotalVolumeLastMonth(),
        //         };
        //     HictoricalDataPredictionResult v = _engine.Predict(dataRecord);
        //     _predictedMonthlyBitcoinPrices[i] = new BitcoinPriceDataViewModel
        //         {
        //             Date = _monthlyBitcoinPrices[i].Date,
        //             Price = v.PredictedValue,
        //         };
        // }

        var mlContext = new MLContext();
        using var stream = File.OpenRead("../../Common/Resources/Models/ForecastBySsa/ForecastBySsa_18.03.2025_19.49.20.zip");
        var trainedModel = mlContext.Model.Load(stream, out var modelSchema);
        var forecastEngine = trainedModel
            .CreateTimeSeriesEngine<HistoricalDataRecord,HictoricalDataSsaPredictionResult>(mlContext);


        HistoricalDataRecord dataRecord = new()
            {
                Date = new DateTimeOffset(DateTime.Parse(_monthlyBitcoinPrices[_monthlyBitcoinPrices.Length-1].Date)).ToUnixTimeSeconds(),
                MarketCap = GetAverageMarketCapLastMonth(),
                TotalVolume = GetAverageTotalVolumeLastMonth(),
            };


        var v = forecastEngine.Predict();
        Console.WriteLine(_monthlyBitcoinPrices.Length);
        Console.WriteLine(v.Forecast.Length);

        for (int i = 0; i < _monthlyBitcoinPrices.Length; i++)
        {
            _predictedMonthlyBitcoinPrices[i] = new BitcoinPriceDataViewModel
                {
                    Date = _monthlyBitcoinPrices[i].Date,
                    Price = v.Forecast[i],
                };
        }
    }

    private string FormatAsUSD(object value)
    {
        return ((double)value).ToString("C0", CultureInfo.CreateSpecificCulture("en-US"));
    }


    public DateTime UnixTimeStampToDateOnly(double unixTimeStamp)
    {   
        unixTimeStamp /= 1000;
        DateTime dateTime = new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc);
        dateTime = dateTime.AddSeconds(unixTimeStamp).ToLocalTime();
        return dateTime;        
    }

    public long DateTimeToUnixTimestamp(DateTime dateTime)
    {
        return new DateTimeOffset(dateTime).ToUnixTimeSeconds();
    }

    public float GetAverageMarketCapLastMonth()
    {
        var thirtyDaysAgo = DateTimeOffset.UtcNow.AddDays(-30).ToUnixTimeMilliseconds();

        var averageMarketCap = _coinHistoricalData.MarketCaps
            .Where(mc => mc[0] >= thirtyDaysAgo) 
            .Select(mc => mc[1])               
            .DefaultIfEmpty()                  
            .Average();                        

        return averageMarketCap;
    }

    public float GetAverageTotalVolumeLastMonth()
    {
        var thirtyDaysAgo = DateTimeOffset.UtcNow.AddDays(-30).ToUnixTimeMilliseconds();

        var averageMarketCap = _coinHistoricalData.MarketCaps
            .Where(mc => mc[0] >= thirtyDaysAgo)
            .Select(mc => mc[1])
            .DefaultIfEmpty()
            .Average();

        return averageMarketCap;
    }

}